{% extends 'base.html' %}
{% load static %}

{% block title %}Record Surveillance Session{% endblock %}

{% block extra_css %}
<style>
    .surveillance-form-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .plant-part-selector {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        margin: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-block;
        min-width: 150px;
    }
    
    .plant-part-selector:hover {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    
    .plant-part-selector.selected {
        background: #2196f3;
        color: white;
        border-color: #1976d2;
    }
    
    .threat-selector {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .threat-selector:hover {
        border-color: #ffc107;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        transform: translateY(-2px);
    }
    
    .threat-selector.selected {
        background: #fff3cd;
        border-color: #ff9800;
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        transform: translateY(-2px);
    }
    
    .threat-selector.selected::before {
        content: "✓";
        position: absolute;
        top: 10px;
        right: 15px;
        color: #ff9800;
        font-weight: bold;
        font-size: 18px;
    }
    
    .form-section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 20px -20px;
    }
    
    .threat-type-filter {
        margin-bottom: 20px;
    }
    
    .threat-type-filter .btn {
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .threat-search {
        margin-bottom: 15px;
    }
    
    .threat-info {
        font-size: 0.9em;
        line-height: 1.4;
    }
    
    .risk-badge {
        position: absolute;
        top: 10px;
        left: 15px;
        font-size: 0.75em;
        padding: 2px 6px;
    }
    
    .threats-found-summary {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        display: none;
    }
    
    .selected-threats-list {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
    }
    
    .selected-threats-list li {
        background: white;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 8px 12px;
        margin-bottom: 5px;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .remove-threat {
        color: #dc3545;
        cursor: pointer;
        margin-left: auto;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-clipboard-list"></i> Record Surveillance Session</h3>
                    <p class="mb-0 text-muted">Capture detailed surveillance data including pests, diseases, and plant parts affected</p>
                </div>
                <div class="card-body">
                    
                    <form method="post" id="surveillanceForm">
                        {% csrf_token %}
                        
                        <!-- Location and Time Information -->
                        <div class="surveillance-form-section">
                            <div class="form-section-header">
                                <h5><i class="fas fa-map-marker-alt"></i> Location & Time Information</h5>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="{{ form.location.id_for_label }}" class="form-label">Location *</label>
                                    {{ form.location }}
                                    {% if form.location.errors %}
                                        <div class="text-danger">{{ form.location.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.date.id_for_label }}" class="form-label">Surveillance Date *</label>
                                    {{ form.date }}
                                    {% if form.date.errors %}
                                        <div class="text-danger">{{ form.date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label for="{{ form.start_time.id_for_label }}" class="form-label">Start Time</label>
                                    {{ form.start_time }}
                                    {% if form.start_time.errors %}
                                        <div class="text-danger">{{ form.start_time.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.end_time.id_for_label }}" class="form-label">End Time</label>
                                    {{ form.end_time }}
                                    {% if form.end_time.errors %}
                                        <div class="text-danger">{{ form.end_time.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.temperature_celsius.id_for_label }}" class="form-label">Temperature (°C)</label>
                                    {{ form.temperature_celsius }}
                                    {% if form.temperature_celsius.errors %}
                                        <div class="text-danger">{{ form.temperature_celsius.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <label for="{{ form.weather_conditions.id_for_label }}" class="form-label">Weather Conditions</label>
                                    {{ form.weather_conditions }}
                                    {% if form.weather_conditions.errors %}
                                        <div class="text-danger">{{ form.weather_conditions.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Plant Parts Surveillance -->
                        <div class="surveillance-form-section">
                            <div class="form-section-header">
                                <h5><i class="fas fa-leaf"></i> Plant Parts Inspected</h5>
                                <small>Select which plant parts you inspected (different pests affect different parts)</small>
                            </div>
                            
                            <div class="row">
                                {% for part in plant_parts %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="plant-part-selector" data-part="{{ part.name }}">
                                        <input type="checkbox" name="plant_parts" value="{{ part.name }}" 
                                               id="part_{{ forloop.counter }}" class="form-check-input me-2" style="display: none;">
                                        <div>
                                            <strong>{{ part.name }}</strong><br>
                                            <small class="text-muted">Priority {{ part.surveillance_priority }}/5</small><br>
                                            <small class="text-info">{{ part.time_multiplier }}x time factor</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Enhanced Pest/Disease Identification -->
                        <div class="surveillance-form-section">
                            <div class="form-section-header">
                                <h5><i class="fas fa-bug"></i> Pests & Diseases Found</h5>
                                <small>Record any threats you observe during surveillance</small>
                            </div>
                            
                            <!-- Threat Type Filter -->
                            <div class="threat-type-filter">
                                <h6>Filter by Type:</h6>
                                <button type="button" class="btn btn-outline-primary threat-filter-btn active" data-filter="all">
                                    All Threats ({{ threats|length }})
                                </button>
                                <button type="button" class="btn btn-outline-success threat-filter-btn" data-filter="pest">
                                    Pests ({{ threats|length }})
                                </button>
                                <button type="button" class="btn btn-outline-warning threat-filter-btn" data-filter="disease">
                                    Diseases ({{ threats|length }})
                                </button>
                            </div>
                            
                            <!-- Threat Search -->
                            <div class="threat-search">
                                <input type="text" class="form-control" id="threatSearch" 
                                       placeholder="Search for specific pests or diseases...">
                            </div>
                            
                            <!-- Threats Grid -->
                            <div class="row" id="threatsGrid">
                                {% for threat in threats %}
                                <div class="col-md-6 col-lg-4 threat-item" 
                                     data-type="{{ threat.threat_type }}" 
                                     data-name="{{ threat.name|lower }}"
                                     data-description="{{ threat.description|lower }}">
                                    <div class="threat-selector" data-threat="{{ threat.id }}">
                                        <span class="risk-badge badge bg-{% if threat.risk_level == 'high' %}danger{% elif threat.risk_level == 'moderate' %}warning{% else %}success{% endif %}">
                                            {{ threat.risk_level|title }}
                                        </span>
                                        <input type="checkbox" name="threats_found" value="{{ threat.id }}" 
                                               id="threat_{{ threat.id }}" class="form-check-input me-2" style="display: none;">
                                        <div class="threat-info">
                                            <h6>{{ threat.name }}</h6>
                                            <span class="badge bg-{% if threat.threat_type == 'pest' %}primary{% else %}info{% endif %} mb-2">
                                                {{ threat.threat_type|title }}
                                            </span>
                                            <p class="small text-muted mb-0">{{ threat.description|truncatewords:12 }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Selected Threats Summary -->
                            <div class="threats-found-summary" id="threatsFoundSummary">
                                <h6><i class="fas fa-exclamation-triangle"></i> Threats Found During Surveillance:</h6>
                                <ul class="selected-threats-list" id="selectedThreatsList"></ul>
                                <div class="alert alert-warning mt-3">
                                    <strong>Important:</strong> Make sure to record detailed findings below and consider immediate action for high-risk threats.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Findings and Notes -->
                        <div class="surveillance-form-section">
                            <div class="form-section-header">
                                <h5><i class="fas fa-sticky-note"></i> Detailed Findings & Notes</h5>
                            </div>
                            
                            <div class="mb-3">
                                <label for="specific_findings" class="form-label">Specific Threat Findings</label>
                                <textarea class="form-control" id="specific_findings" name="specific_findings" rows="4"
                                          placeholder="For each threat found, describe:
• Which plant parts were affected
• Severity of infestation/infection
• Distribution pattern (localized/widespread)
• Stage of pest/disease development
• Environmental conditions that may have contributed"></textarea>
                                <div class="form-text">Be specific about location, severity, and spread of each threat</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="action_taken" class="form-label">Immediate Actions Taken</label>
                                <textarea class="form-control" id="action_taken" name="action_taken" rows="3"
                                          placeholder="Record any immediate actions taken:
• Samples collected for identification
• Affected plant parts removed
• Treatments applied
• Area isolated or marked"></textarea>
                            </div>
                            
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="text-danger">{{ form.notes.errors }}</div>
                            {% endif %}
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>General Notes:</strong> Weather conditions, unusual observations, 
                                    equipment used, follow-up recommendations, etc.
                                </small>
                            </div>
                        </div>
                        
                        <!-- Follow-up Actions -->
                        <div class="surveillance-form-section">
                            <div class="form-section-header">
                                <h5><i class="fas fa-tasks"></i> Follow-up Required</h5>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="requires_followup" name="requires_followup">
                                        <label class="form-check-label" for="requires_followup">
                                            <strong>This location requires follow-up surveillance</strong>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="requires_treatment" name="requires_treatment">
                                        <label class="form-check-label" for="requires_treatment">
                                            <strong>Treatment/intervention needed</strong>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="followup_date" class="form-label">Recommended Follow-up Date</label>
                                    <input type="date" class="form-control" id="followup_date" name="followup_date">
                                    <div class="form-text">When should this location be checked again?</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'surveillance_calculator' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Surveillance Record
                            </button>
                        </div>
                        
                    </form>
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Plant part selector interactions
    document.querySelectorAll('.plant-part-selector').forEach(selector => {
        selector.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('selected', checkbox.checked);
        });
    });
    
    // Enhanced threat selector interactions
    document.querySelectorAll('.threat-selector').forEach(selector => {
        selector.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('selected', checkbox.checked);
            
            updateThreatsFoundSummary();
        });
    });
    
    // Threat type filter
    document.querySelectorAll('.threat-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.threat-filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            filterThreats(filter);
        });
    });
    
    // Threat search functionality
    document.getElementById('threatSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        searchThreats(searchTerm);
    });
    
    function filterThreats(type) {
        document.querySelectorAll('.threat-item').forEach(item => {
            if (type === 'all' || item.dataset.type === type) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function searchThreats(searchTerm) {
        document.querySelectorAll('.threat-item').forEach(item => {
            const name = item.dataset.name;
            const description = item.dataset.description;
            
            if (name.includes(searchTerm) || description.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function updateThreatsFoundSummary() {
        const selectedThreats = document.querySelectorAll('.threat-selector.selected');
        const summary = document.getElementById('threatsFoundSummary');
        const list = document.getElementById('selectedThreatsList');
        
        if (selectedThreats.length > 0) {
            summary.style.display = 'block';
            list.innerHTML = '';
            
            selectedThreats.forEach(selector => {
                const threatName = selector.querySelector('h6').textContent;
                const threatType = selector.querySelector('.badge').textContent;
                const riskLevel = selector.querySelector('.risk-badge').textContent;
                
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div>
                        <strong>${threatName}</strong>
                        <span class="badge bg-secondary ms-2">${threatType}</span>
                        <span class="badge bg-warning ms-1">${riskLevel} Risk</span>
                    </div>
                    <span class="remove-threat" onclick="removeThreat(this)">×</span>
                `;
                list.appendChild(listItem);
            });
        } else {
            summary.style.display = 'none';
        }
    }
    
    // Remove threat function
    window.removeThreat = function(element) {
        const listItem = element.parentElement;
        const threatName = listItem.querySelector('strong').textContent;
        
        // Find and uncheck the corresponding threat selector
        document.querySelectorAll('.threat-selector').forEach(selector => {
            if (selector.querySelector('h6').textContent === threatName) {
                const checkbox = selector.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
                selector.classList.remove('selected');
            }
        });
        
        updateThreatsFoundSummary();
    };
    
    // Form validation
    document.getElementById('surveillanceForm').addEventListener('submit', function(e) {
        const location = document.querySelector('select[name="location"]').value;
        const date = document.querySelector('input[name="date"]').value;
        
        if (!location || !date) {
            e.preventDefault();
            alert('Please select a location and date for your surveillance session.');
            return;
        }
        
        // Check if at least one plant part is selected
        const plantParts = document.querySelectorAll('input[name="plant_parts"]:checked');
        if (plantParts.length === 0) {
            e.preventDefault();
            alert('Please select at least one plant part that you inspected.');
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
    });
    
    // Set current time as default for start time
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    const startTimeInput = document.querySelector('input[name="start_time"]');
    if (startTimeInput && !startTimeInput.value) {
        startTimeInput.value = currentTime;
    }
});
</script>
{% endblock %}